-- 0) Run as ACCOUNTADMIN (or SYSADMIN + SECURITYADMIN where appropriate)

USE ROLE ACCOUNTADMIN;



-- 1) Create role

CREATE ROLE IF NOT EXISTS DBT\_ROLE;



-- 2) Warehouse usage (and future-proofing if you want)

GRANT USAGE ON WAREHOUSE COMPUTE\_WH TO ROLE DBT\_ROLE;



-- 3) Create DB + Schema (do NOT do this as DBT\_ROLE unless it already has rights)

CREATE DATABASE IF NOT EXISTS ENTSOE\_DB;

CREATE SCHEMA IF NOT EXISTS ENTSOE\_DB.ENTSOE\_SCHEMA;

USE ROLE ACCOUNTADMIN;



CREATE SCHEMA IF NENTSOE\_DB.DBT\_DEVOT EXISTS ENTSOE\_DB.DBT\_DEV;



-- 4) Grant basic access to db + schema

GRANT USAGE ON DATABASE ENTSOE\_DB TO ROLE DBT\_ROLE;

GRANT USAGE ON SCHEMA ENTSOE\_DB.ENTSOE\_SCHEMA TO ROLE DBT\_ROLE;



-- 5) Allow dbt to build models in the schema

GRANT CREATE TABLE ON SCHEMA ENTSOE\_DB.ENTSOE\_SCHEMA TO ROLE DBT\_ROLE;

GRANT CREATE VIEW  ON SCHEMA ENTSOE\_DB.ENTSOE\_SCHEMA TO ROLE DBT\_ROLE;

GRANT CREATE SCHEMA ON DATABASE ENTSOE\_DB TO ROLE DBT\_ROLE;





-- (Optional but common) for dbt temporary objects / some materializations

GRANT CREATE TEMPORARY TABLE ON SCHEMA ENTSOE\_DB.ENTSOE\_SCHEMA TO ROLE DBT\_ROLE;



-- 6) Let dbt read what it creates (and what already exists)

GRANT SELECT ON ALL TABLES IN SCHEMA ENTSOE\_DB.ENTSOE\_SCHEMA TO ROLE DBT\_ROLE;

GRANT SELECT ON FUTURE TABLES IN SCHEMA ENTSOE\_DB.ENTSOE\_SCHEMA TO ROLE DBT\_ROLE;



GRANT SELECT ON ALL VIEWS IN SCHEMA ENTSOE\_DB.ENTSOE\_SCHEMA TO ROLE DBT\_ROLE;

GRANT SELECT ON FUTURE VIEWS IN SCHEMA ENTSOE\_DB.ENTSOE\_SCHEMA TO ROLE DBT\_ROLE;



-- create user DBT

CREATE USER IF NOT EXISTS DBT

  PASSWORD =

  DEFAULT\_ROLE = DBT\_ROLE

  DEFAULT\_WAREHOUSE = COMPUTE\_WH

  MUST\_CHANGE\_PASSWORD = FALSE;



-- grant role dbt\_role to the user dbt

GRANT ROLE DBT\_ROLE TO USER DBT;





--set database and schema for use

USE DATABASE entsoe\_db;

USE SCHEMA entsoe\_schema;

USE WAREHOUSE COMPUTE\_WH;





--CREATE FILE FORMAT



CREATE OR REPLACE FILE FORMAT json\_file\_format

TYPE = JSON

COMMENT = 'File format for JSON data';



-- run as a role that owns the schema (ACCOUNTADMIN/SYSADMIN)

GRANT USAGE

ON FILE FORMAT ENTSOE\_DB.ENTSOE\_SCHEMA.JSON\_FILE\_FORMAT

TO ROLE DBT\_ROLE;



-- optional future-proof:

GRANT USAGE

ON FUTURE FILE FORMATS IN SCHEMA ENTSOE\_DB.ENTSOE\_SCHEMA

TO ROLE DBT\_ROLE;





CREATE OR REPLACE STORAGE INTEGRATION s3\_entsoe\_init

STORAGE\_PROVIDER = S3

TYPE = EXTERNAL\_STAGE

ENABLED = TRUE

STORAGE\_AWS\_ROLE\_ARN =

STORAGE\_ALLOWED\_LOCATIONS = ('s3://day-ahead-prices-adewale-franklin/');



-- run as ACCOUNTADMIN (recommended)

GRANT USAGE

ON INTEGRATION S3\_ENTSOE\_INIT

TO ROLE DBT\_ROLE;



--GET THE STORAGE\_AWS\_IAM\_USER\_ARN from Snowflake \& STORAGE\_AWS\_EXTERNAL\_ID from Snowflake NEEDED FOR AWS IAM ROLE POLICY



DESC INTEGRATION s3\_entsoe\_init;

